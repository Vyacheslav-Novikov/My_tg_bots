import requests
import json

API_KEY = "—Ç–æ–∫–µ–Ω"
API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "deepseek/deepseek-chat"


async def generate_ai_answer(text: str, stars: int) -> str:
    # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
    user_text = text if text else "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–∫—Å—Ç"

    prompt = f"""
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä Wildberries.

–í–æ—Ç –æ—Ç–∑—ã–≤ –∫–ª–∏–µ–Ω—Ç–∞:
"{user_text}"

–û—Ü–µ–Ω–∫–∞: {stars} ‚≠ê

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç:
‚Ä¢ –ï—Å–ª–∏ –æ—Ç–∑—ã–≤ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π ‚Äî –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏, –æ—Ç–º–µ—Ç—å —Ç–æ–≤–∞—Ä, –ø–æ–∂–µ–ª–∞–π –ø—Ä–∏—è—Ç–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.
‚Ä¢ –ï—Å–ª–∏ –æ—Ç–∑—ã–≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî –∏–∑–≤–∏–Ω–∏—Å—å, –ø—Ä–æ—è–≤–∏ —ç–º–ø–∞—Ç–∏—é, –Ω–æ –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
‚Ä¢ –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç ‚Äî –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–Ω–∞—á–∞–ª–µ –ª—é–±–æ–≥–æ –æ—Ç–∑—ã–≤–∞ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –∑–∞ –æ—Ç–∑—ã–≤ –∏–ª–∏ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.
‚Ä¢ –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏.
‚Ä¢ –ù–µ –±—É–¥—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º ‚Äî 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º.
‚Ä¢ –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞ –Ω–µ—Ç, –Ω–µ –Ω–∞–¥–æ –æ–± —ç—Ç–æ–º –º–Ω–µ —Å–æ–æ–±—â–∞—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ 
"""

    payload = {
        "model": MODEL,
        "max_tokens": 300,  # <==== –í–ê–ñ–ù–û!
        "messages": [
            {"role": "system", "content": "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä Wildberries"},
            {"role": "user", "content": prompt}
        ]
    }

    r = requests.post(
        API_URL,
        headers={
            "Content-Type": "application/json",
            "Authorization": f"Bearer {API_KEY}"
        },
        json=payload  # <==== –ò–°–ü–†–ê–í–õ–ï–ù–û
    )

    try:
        response = r.json()
        return response["choices"][0]["message"]["content"].strip()
    except Exception as e:
        print("AI ERROR:", e, r.text)
        return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."


async def analyze_reviews_summary(text: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–∑—ã–≤—ã –∏ –¥–µ–ª–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É
    –ë–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º!
    """

    prompt = f"""
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –æ—Ç–∑—ã–≤–æ–≤ Wildberries.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã –∏ —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É:

{text}

–°–î–ï–õ–ê–ô –ö–†–ê–¢–ö–£–Æ –í–´–ñ–ò–ú–ö–£ (–º–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤):
1. –ù–∞ —á—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –•–í–ê–õ–Ø–¢ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏?
2. –ù–∞ —á—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –ñ–ê–õ–£–Æ–¢–°–Ø –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏? 
3. –û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¢–û–õ–¨–ö–û –í –¢–ê–ö–û–ú –°–¢–ò–õ–ï:
üëç –•–≤–∞–ª—è—Ç: [–∫—Ä–∞—Ç–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–ª—é—Å—ã]
üëé –ñ–∞–ª—É—é—Ç—Å—è: [–∫—Ä–∞—Ç–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–∏–Ω—É—Å—ã]  
üí° –í—ã–≤–æ–¥: [–≥–ª–∞–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]

–ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º! –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º, —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑.
"""

    payload = {
        "model": MODEL,
        "max_tokens": 300,
        "messages": [
            {"role": "system", "content": "–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –æ—Ç–∑—ã–≤–æ–≤. –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑, –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º."},
            {"role": "user", "content": prompt}
        ]
    }

    r = requests.post(
        API_URL,
        headers={
            "Content-Type": "application/json",
            "Authorization": f"Bearer {API_KEY}"
        },
        json=payload
    )

    try:
        response = r.json()
        result = response["choices"][0]["message"]["content"].strip()

        # üî• –£–ë–ò–†–ê–ï–ú –õ–Æ–ë–´–ï –§–†–ê–ó–´, –ö–û–¢–û–†–´–ï –í–´–ì–õ–Ø–î–Ø–¢ –ö–ê–ö –û–¢–í–ï–¢–´ –ü–û–ö–£–ü–ê–¢–ï–õ–Ø–ú
        unwanted_patterns = [
            "–†–∞–¥—ã, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å",
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤",
            "–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å",
            "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
            "–ñ–µ–ª–∞–µ–º –ø—Ä–∏—è—Ç–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫",
            "–ù–∞–¥–µ–µ–º—Å—è –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"
        ]

        for pattern in unwanted_patterns:
            if pattern in result:
                # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –¥–æ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–π —Ñ—Ä–∞–∑—ã
                result = result.split(pattern)[0].strip()
                break

        return result
    except Exception as e:
        print("AI ANALYSIS ERROR:", e, r.text)
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤"


# –î–æ–±–∞–≤—å –≤ –∫–æ–Ω–µ—Ü ai_1.py

async def generate_ai_question_answer(question_text: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –í–û–ü–†–û–° –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (–Ω–µ –æ—Ç–∑—ã–≤!)
    """
    prompt = f"""
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä Wildberries.

–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –æ —Ç–æ–≤–∞—Ä–µ:
"{question_text}"

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ö–†–ê–¢–ö–ò–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å:
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–∫–∞–∂–∏ —á—Ç–æ –º—ã –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ –æ–±–ª–∞–¥–∞–µ–º –¥–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π 
- –ù–µ –æ–±–µ—â–∞–π —Ç–æ, —á–µ–≥–æ –Ω–µ –º–æ–∂–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å
- 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
- –ò—Å–ø–æ–ª—å–∑—É–π –≤–µ–∂–ª–∏–≤—ã–π —Ç–æ–Ω
"""

    payload = {
        "model": MODEL,
        "max_tokens": 300,
        "messages": [
            {"role": "system", "content": "–¢—ã ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä Wildberries, –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π"},
            {"role": "user", "content": prompt}
        ]
    }

    r = requests.post(
        API_URL,
        headers={
            "Content-Type": "application/json",
            "Authorization": f"Bearer {API_KEY}"
        },
        json=payload
    )

    try:
        response = r.json()
        return response["choices"][0]["message"]["content"].strip()
    except Exception as e:
        print("AI QUESTION ERROR:", e, r.text)
        return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –º–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
